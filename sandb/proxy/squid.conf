# AI Sandbox Squid Proxy Configuration
# Whitelists only domains needed for AI coding assistants

# Port
http_port 3128

# Timeouts for streaming/long-lived connections (Claude Code, Copilot)
read_timeout 120 minutes
client_lifetime 1 day
connect_timeout 30 seconds
request_timeout 5 minutes

# Don't buffer streaming responses
quick_abort_min 0 KB
quick_abort_max 0 KB

# Define allowed ports (HTTPS only - modern clients use HTTPS by default)
acl SSL_ports port 443
acl Safe_ports port 443

# Deny non-safe ports (blocks HTTP 80, arbitrary ports like 8080, 22, etc.)
http_access deny !Safe_ports

# ============================================================================
# WHITELISTED DOMAINS
# ============================================================================

# Claude/Anthropic
acl allowed_domains dstdomain .anthropic.com

# OpenAI (uncomment if using OpenAI-based tools)
# acl allowed_domains dstdomain .openai.com

# GitHub - Authentication & OAuth
acl allowed_domains dstdomain github.com
acl allowed_domains dstdomain api.github.com

# GitHub Copilot - Core API
acl allowed_domains dstdomain copilot-proxy.githubusercontent.com
acl allowed_domains dstdomain origin-tracker.githubusercontent.com
acl allowed_domains dstdomain copilot-telemetry.githubusercontent.com

# GitHub Copilot - Plan endpoints (wildcard covers all plans)
acl allowed_domains dstdomain .githubcopilot.com

# GitHub - Telemetry (optional - can comment out to block)
acl allowed_domains dstdomain collector.github.com
acl allowed_domains dstdomain default.exp-tas.com

# Anthropic Telemetry (optional - can comment out to block)
acl allowed_domains dstdomain statsig.anthropic.com

# NPM registry (for Claude Code updates)
acl allowed_domains dstdomain registry.npmjs.org

# ============================================================================
# OPTIONAL: Additional package registries
# ============================================================================
# Go modules - DISABLED for security
# proxy.golang.org redirects to storage.googleapis.com which hosts arbitrary
# user content, enabling data exfiltration. Instead, mount host's Go module
# cache read-only. Run `go mod download` on host first.
# acl allowed_domains dstdomain proxy.golang.org
# acl allowed_domains dstdomain sum.golang.org

# Python PyPI
# acl allowed_domains dstdomain pypi.org
# acl allowed_domains dstdomain files.pythonhosted.org

# Rust crates
# acl allowed_domains dstdomain crates.io
# acl allowed_domains dstdomain static.crates.io

# ============================================================================
# SECURITY NOTES
# ============================================================================
# DISABLED by default (security risks):
# - storage.googleapis.com: Hosts arbitrary user content, enables data exfil
# - .sentry.io: Allows any Sentry project, enabling data exfiltration

# ============================================================================
# ACCESS RULES
# ============================================================================

# HTTPS: Allow CONNECT only to whitelisted domains
http_access allow CONNECT SSL_ports allowed_domains
http_access deny CONNECT all

# HTTP: Allow only whitelisted domains (rarely used, most is HTTPS)
http_access allow allowed_domains

# Deny everything else
http_access deny all

# Disable caching
cache deny all

# Logging
access_log /var/log/squid/access.log
cache_log /var/log/squid/cache.log

# Log rotation - rotate when access.log reaches 10MB, keep 2 rotations
logfile_rotate 2
