#!/bin/bash
# Generated by pgflock - do not edit manually
NUM_DBS={{.NumDatabases}}
echo "Setup ${NUM_DBS} test databases"

cd /var/lib/postgresql || exit

echo 'Creating user... (ignore role already exist error for re-runs)'
psql -c "CREATE USER {{.Username}} WITH PASSWORD '{{.Password}}' CREATEDB;"
psql -c "ALTER ROLE {{.Username}} SUPERUSER;"
psql -c "CREATE DATABASE {{.Username}} WITH ENCODING '{{.Encoding}}' LC_COLLATE='{{.LCCollate}}' LC_CTYPE='{{.LCCtype}}' TEMPLATE=template0;"
psql -c "ALTER DATABASE {{.Username}} OWNER TO {{.Username}};"
psql -d {{.Username}} -c "ALTER SCHEMA public OWNER TO {{.Username}};"
echo 'User creation done!'

# Create test_template database with extensions
PGPASSWORD={{.Password}} psql -U {{.Username}} -c "CREATE DATABASE test_template WITH ENCODING '{{.Encoding}}' LC_COLLATE='{{.LCCollate}}' LC_CTYPE='{{.LCCtype}}' TEMPLATE=template0;"
{{range .Extensions}}
PGPASSWORD={{$.Password}} psql -U {{$.Username}} -d test_template -c 'CREATE EXTENSION IF NOT EXISTS {{.}} CASCADE;'
{{end}}
PGPASSWORD={{.Password}} psql -U {{.Username}} -d test_template -c 'VACUUM FREEZE;'
PGPASSWORD={{.Password}} psql -U {{.Username}} -d test_template -c "UPDATE pg_database SET datistemplate = TRUE WHERE datname = 'test_template';"

echo 'Database creation... (ignore already exist error for re-runs)'
for i in $(seq 1 ${NUM_DBS})
do
  echo "Create database {{.DatabasePrefix}}${i}"
  psql -c "CREATE DATABASE {{.DatabasePrefix}}${i} WITH ENCODING '{{.Encoding}}' LC_COLLATE='{{.LCCollate}}' LC_CTYPE='{{.LCCtype}}' TEMPLATE=template0;"
  psql -c "ALTER DATABASE {{.DatabasePrefix}}${i} OWNER TO {{.Username}};"
  psql -d "{{.DatabasePrefix}}${i}" -c "ALTER SCHEMA public OWNER to {{.Username}};"
  echo "{{.DatabasePrefix}}${i} created!"
done
